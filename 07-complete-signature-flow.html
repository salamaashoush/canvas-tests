<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test 7: Complete Signature Flow</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=Dancing+Script&family=Great+Vibes&family=Lato:wght@400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border-color: #30363d;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --text-muted: #484f58;
      --accent-blue: #58a6ff;
      --accent-green: #3fb950;
      --accent-red: #f85149;
      --accent-yellow: #d29922;
      --accent-purple: #a371f7;
      --pass-bg: rgba(63, 185, 80, 0.15);
      --pass-border: rgba(63, 185, 80, 0.4);
      --fail-bg: rgba(248, 81, 73, 0.15);
      --fail-border: rgba(248, 81, 73, 0.4);
      --warn-bg: rgba(210, 153, 34, 0.15);
      --warn-border: rgba(210, 153, 34, 0.4);
      --transparency-grid: repeating-conic-gradient(#21262d 0% 25%, #161b22 0% 50%) 50% / 16px 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Space Grotesk', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    /* Header */
    .header {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .header-top {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .test-badge {
      background: var(--accent-purple);
      color: #fff;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--text-primary);
    }

    .hypothesis {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-left: 3px solid var(--accent-yellow);
      padding: 16px 20px;
      border-radius: 8px;
      margin-top: 16px;
    }

    .hypothesis-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent-yellow);
      margin-bottom: 4px;
    }

    .hypothesis p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Summary Panel */
    .summary-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .summary-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .summary-card.pass { border-color: var(--pass-border); background: var(--pass-bg); }
    .summary-card.fail { border-color: var(--fail-border); background: var(--fail-bg); }
    .summary-card.warn { border-color: var(--warn-border); background: var(--warn-bg); }
    .summary-card.info { border-color: var(--accent-blue); background: rgba(88, 166, 255, 0.1); }

    .summary-count {
      font-size: 48px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      line-height: 1;
    }

    .summary-card.pass .summary-count { color: var(--accent-green); }
    .summary-card.fail .summary-count { color: var(--accent-red); }
    .summary-card.warn .summary-count { color: var(--accent-yellow); }
    .summary-card.info .summary-count { color: var(--accent-blue); }

    .summary-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    /* Test Section */
    .test-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 20px;
      overflow: hidden;
      transition: border-color 0.2s;
    }

    .test-section:hover {
      border-color: var(--text-muted);
    }

    .test-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: var(--bg-tertiary);
      cursor: pointer;
      user-select: none;
    }

    .test-header:hover {
      background: #282e36;
    }

    .test-title-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .test-number {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--bg-primary);
      padding: 4px 10px;
      border-radius: 6px;
    }

    .test-title {
      font-size: 16px;
      font-weight: 600;
    }

    .test-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      padding: 6px 14px;
      border-radius: 20px;
    }

    .test-status.pass {
      background: var(--pass-bg);
      color: var(--accent-green);
      border: 1px solid var(--pass-border);
    }

    .test-status.fail {
      background: var(--fail-bg);
      color: var(--accent-red);
      border: 1px solid var(--fail-border);
    }

    .test-status.warn {
      background: var(--warn-bg);
      color: var(--accent-yellow);
      border: 1px solid var(--warn-border);
    }

    .test-status.pending {
      background: var(--bg-primary);
      color: var(--text-muted);
      border: 1px solid var(--border-color);
    }

    .test-content {
      padding: 20px;
      border-top: 1px solid var(--border-color);
    }

    .test-description {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 20px;
    }

    .code-ref {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--accent-purple);
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* Controls */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }

    button {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    button:hover {
      background: #282e36;
      border-color: var(--text-muted);
    }

    button.primary {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: var(--bg-primary);
    }

    button.primary:hover {
      background: #79b8ff;
    }

    input[type="text"], input[type="file"], select {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    select {
      min-width: 120px;
    }

    .color-swatch {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      border: 2px solid var(--border-color);
      cursor: pointer;
      display: inline-block;
      vertical-align: middle;
    }

    .color-swatch.selected {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3);
    }

    /* Canvas Display */
    .canvas-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .canvas-panel {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .canvas-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
    }

    .canvas-panel-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .canvas-dimensions {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--accent-blue);
      background: var(--bg-secondary);
      padding: 3px 8px;
      border-radius: 4px;
    }

    .canvas-wrapper {
      padding: 16px;
      background: var(--transparency-grid);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 120px;
    }

    canvas {
      background: #ffffff;
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      cursor: crosshair;
      touch-action: none;
    }

    .canvas-preview {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .canvas-meta {
      padding: 10px 14px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      gap: 16px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-primary);
    }

    .canvas-meta strong {
      color: var(--text-secondary);
    }

    /* Metrics Panel */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 14px;
    }

    .metric-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .metric-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .metric-value.zero { color: var(--accent-red); }
    .metric-value.warn { color: var(--accent-yellow); }

    /* Font Grid */
    .font-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .font-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .font-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
    }

    .font-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-purple);
    }

    .font-preview {
      padding: 16px;
      background: var(--transparency-grid);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 80px;
    }

    .font-preview img {
      max-width: 100%;
      height: auto;
    }

    .font-meta {
      padding: 10px 14px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      gap: 16px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-primary);
    }

    /* Frame Grid */
    .frame-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .frame-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .frame-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
    }

    .frame-card-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-blue);
    }

    .frame-preview {
      padding: 16px;
      background: var(--transparency-grid);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100px;
    }

    .frame-preview img {
      max-width: 100%;
      height: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .frame-meta {
      padding: 10px 14px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-primary);
    }

    /* Validation Results */
    .validation-results {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .validation-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
    }

    .validation-item:last-child { border-bottom: none; }

    .validation-name { color: var(--text-secondary); }
    .validation-status { font-weight: 600; }
    .validation-status.valid { color: var(--accent-green); }
    .validation-status.invalid { color: var(--accent-red); }

    /* Data URI Panel */
    .data-uri-panel {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-top: 16px;
      overflow: hidden;
    }

    .data-uri-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
    }

    .data-uri-header:hover {
      background: #282e36;
    }

    .data-uri-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .data-uri-toggle {
      color: var(--text-muted);
      font-size: 10px;
      transition: transform 0.2s;
    }

    .data-uri-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .data-uri-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .data-uri-length {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--accent-purple);
    }

    .copy-btn {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      padding: 4px 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .copy-btn:hover {
      background: var(--accent-blue);
      color: var(--bg-primary);
      border-color: var(--accent-blue);
    }

    .copy-btn.copied {
      background: var(--accent-green);
      border-color: var(--accent-green);
      color: var(--bg-primary);
    }

    .data-uri-content {
      padding: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
      word-break: break-all;
      max-height: 100px;
      overflow-y: auto;
      line-height: 1.8;
    }

    .data-uri-content.collapsed {
      display: none;
    }

    /* Log Panel */
    .log-panel {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-top: 16px;
      overflow: hidden;
    }

    .log-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
    }

    .log-header:hover {
      background: #282e36;
    }

    .log-toggle {
      color: var(--text-muted);
      font-size: 10px;
      transition: transform 0.2s;
    }

    .log-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .log-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .log-content {
      padding: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-secondary);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.7;
    }

    .log-content.collapsed {
      display: none;
    }

    /* Browser Info */
    .browser-info {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-top: 32px;
    }

    .browser-info h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .browser-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .browser-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border-radius: 6px;
    }

    .browser-item-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .browser-item-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-primary);
    }

    /* Upload area */
    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 32px;
      text-align: center;
      background: var(--bg-tertiary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-area:hover {
      border-color: var(--accent-blue);
      background: rgba(88, 166, 255, 0.05);
    }

    .upload-area.dragover {
      border-color: var(--accent-blue);
      background: rgba(88, 166, 255, 0.1);
    }

    .upload-text {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .canvas-grid { grid-template-columns: 1fr; }
      .font-grid { grid-template-columns: 1fr; }
      .frame-grid { grid-template-columns: 1fr; }
      h1 { font-size: 22px; }
    }

    .back-link {
      display: inline-block;
      margin-bottom: 1rem;
      color: var(--accent-blue);
      text-decoration: none;
      font-size: 0.9rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <a href="index.html" class="back-link">Back to Test Index</a>
      <div class="header-top">
        <span class="test-badge">Test 07</span>
        <h1>Complete Signature Flow</h1>
      </div>
      <div class="hypothesis">
        <div class="hypothesis-label">Test Purpose</div>
        <p>End-to-end signature capture workflow using the exact same logic as the production code. Tests all signature types (draw, type, upload, saved), frame generation (the signature frame module), and validation (the image validator).</p>
      </div>
    </header>

    <div class="summary-panel">
      <div class="summary-card info">
        <div class="summary-count" id="stat-captured">0</div>
        <div class="summary-label">Captured</div>
      </div>
      <div class="summary-card pass">
        <div class="summary-count" id="stat-passed">0</div>
        <div class="summary-label">Passed</div>
      </div>
      <div class="summary-card fail">
        <div class="summary-count" id="stat-failed">0</div>
        <div class="summary-label">Failed</div>
      </div>
      <div class="summary-card warn">
        <div class="summary-count" id="stat-dpr">-</div>
        <div class="summary-label">DPR</div>
      </div>
    </div>

    <!-- Test 7.1: Draw Signature -->
    <div class="test-section">
      <div class="test-header">
        <div class="test-title-group">
          <span class="test-number">7.1</span>
          <span class="test-title">Draw Signature Mode</span>
        </div>
        <div class="test-status pending" id="status-7-1">Pending</div>
      </div>
      <div class="test-content">
        <p class="test-description">Mimics the draw signature component. Uses the exact hasSignature() logic (42px minimum path length) and getSignatureFromCanvas() extraction.</p>

        <div class="controls">
          <span class="color-swatch selected" style="background: #000000;" data-color="#000000" onclick="selectColor(this)"></span>
          <span class="color-swatch" style="background: #0000ff;" data-color="#0000ff" onclick="selectColor(this)"></span>
          <span class="color-swatch" style="background: #ff0000;" data-color="#ff0000" onclick="selectColor(this)"></span>
          <span class="color-swatch" style="background: #006400;" data-color="#006400" onclick="selectColor(this)"></span>
        </div>

        <div class="canvas-grid">
          <div class="canvas-panel">
            <div class="canvas-panel-header">
              <span class="canvas-panel-title">Drawing Canvas</span>
              <span class="canvas-dimensions" id="draw-display-size">-</span>
            </div>
            <div class="canvas-wrapper">
              <canvas id="draw-canvas"></canvas>
            </div>
            <div class="canvas-meta">
              <span>Actual: <strong id="draw-actual-size">-</strong></span>
              <span>Path Length: <strong id="draw-path-length">0</strong>px</span>
              <span>hasSignature: <strong id="draw-has-sig">false</strong></span>
            </div>
          </div>
          <div class="canvas-panel">
            <div class="canvas-panel-header">
              <span class="canvas-panel-title">Captured Result</span>
              <span class="canvas-dimensions" id="draw-result-size">-</span>
            </div>
            <div class="canvas-wrapper">
              <img id="draw-result" class="canvas-preview" alt="Captured signature">
            </div>
            <div class="canvas-meta">
              <span>Non-transparent: <strong id="draw-pixels">-</strong></span>
            </div>
          </div>
        </div>

        <div class="controls">
          <button onclick="clearDrawCanvas()">Clear</button>
          <button class="primary" onclick="captureDrawSignature()">Capture (getSignatureFromCanvas)</button>
        </div>

        <div class="data-uri-panel" id="draw-uri-panel" style="display: none;">
          <div class="data-uri-header" onclick="toggleDataUri('draw')">
            <div class="data-uri-title">
              <span class="data-uri-toggle" id="draw-uri-toggle">&#9660;</span>
              <span class="data-uri-label">Data URI</span>
              <span class="data-uri-length" id="draw-uri-length">-</span>
            </div>
            <button class="copy-btn" onclick="event.stopPropagation(); copyDataUri('draw-uri-content', this)">Copy</button>
          </div>
          <div class="data-uri-content" id="draw-uri-content"></div>
        </div>

        <div class="log-panel">
          <div class="log-header" onclick="toggleLog('draw')">
            <span class="log-toggle" id="draw-log-toggle">&#9660;</span>
            <span class="log-title">Debug Log</span>
          </div>
          <div class="log-content collapsed" id="draw-log"></div>
        </div>
      </div>
    </div>

    <!-- Test 7.2: Text Signature -->
    <div class="test-section">
      <div class="test-header">
        <div class="test-title-group">
          <span class="test-number">7.2</span>
          <span class="test-title">Text Signature Mode</span>
        </div>
        <div class="test-status pending" id="status-7-2">Pending</div>
      </div>
      <div class="test-content">
        <p class="test-description">Exact implementation of the text signature module. Uses the same font-fitting loop that reduces fontSize until text fits within canvas width minus 10% margin.</p>

        <div class="controls">
          <input type="text" id="sig-text" value="John Smith" placeholder="Enter signature text" style="width: 200px;">
          <select id="sig-color">
            <option value="#000000">Black</option>
            <option value="#0000ff">Blue</option>
            <option value="#ff0000">Red</option>
            <option value="#006400">Green</option>
          </select>
          <button class="primary" onclick="generateTextSignatures()">Generate Text Signatures</button>
        </div>

        <div class="font-grid" id="text-results"></div>

        <div class="data-uri-panel" id="text-uri-panel" style="display: none;">
          <div class="data-uri-header" onclick="toggleDataUri('text')">
            <div class="data-uri-title">
              <span class="data-uri-toggle" id="text-uri-toggle">&#9660;</span>
              <span class="data-uri-label">Data URI</span>
              <span class="data-uri-length" id="text-uri-length">-</span>
            </div>
            <button class="copy-btn" onclick="event.stopPropagation(); copyDataUri('text-uri-content', this)">Copy</button>
          </div>
          <div class="data-uri-content" id="text-uri-content"></div>
        </div>

        <div class="log-panel">
          <div class="log-header" onclick="toggleLog('text')">
            <span class="log-toggle" id="text-log-toggle">&#9660;</span>
            <span class="log-title">Debug Log</span>
          </div>
          <div class="log-content collapsed" id="text-log"></div>
        </div>
      </div>
    </div>

    <!-- Test 7.3: Upload Signature -->
    <div class="test-section">
      <div class="test-header">
        <div class="test-title-group">
          <span class="test-number">7.3</span>
          <span class="test-title">Upload Signature Mode</span>
        </div>
        <div class="test-status pending" id="status-7-3">Pending</div>
      </div>
      <div class="test-content">
        <p class="test-description">Mimics the upload signature component. Loads image via loadImage(), draws to canvas, then extracts via getSignatureFromCanvas().</p>

        <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
          <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
          <div class="upload-text">Drop an image here or click to select</div>
        </div>

        <div class="canvas-grid" style="margin-top: 20px;">
          <div class="canvas-panel">
            <div class="canvas-panel-header">
              <span class="canvas-panel-title">Upload Canvas</span>
              <span class="canvas-dimensions" id="upload-display-size">-</span>
            </div>
            <div class="canvas-wrapper">
              <canvas id="upload-canvas" style="display: none;"></canvas>
              <span id="upload-placeholder" style="color: var(--text-muted);">No image loaded</span>
            </div>
            <div class="canvas-meta">
              <span>Original: <strong id="upload-original-size">-</strong></span>
            </div>
          </div>
          <div class="canvas-panel">
            <div class="canvas-panel-header">
              <span class="canvas-panel-title">Captured Result</span>
              <span class="canvas-dimensions" id="upload-result-size">-</span>
            </div>
            <div class="canvas-wrapper">
              <img id="upload-result" class="canvas-preview" alt="Uploaded signature">
            </div>
            <div class="canvas-meta">
              <span>Non-transparent: <strong id="upload-pixels">-</strong></span>
            </div>
          </div>
        </div>

        <div class="data-uri-panel" id="upload-uri-panel" style="display: none;">
          <div class="data-uri-header" onclick="toggleDataUri('upload')">
            <div class="data-uri-title">
              <span class="data-uri-toggle" id="upload-uri-toggle">&#9660;</span>
              <span class="data-uri-label">Data URI</span>
              <span class="data-uri-length" id="upload-uri-length">-</span>
            </div>
            <button class="copy-btn" onclick="event.stopPropagation(); copyDataUri('upload-uri-content', this)">Copy</button>
          </div>
          <div class="data-uri-content" id="upload-uri-content"></div>
        </div>

        <div class="log-panel">
          <div class="log-header" onclick="toggleLog('upload')">
            <span class="log-toggle" id="upload-log-toggle">&#9660;</span>
            <span class="log-title">Debug Log</span>
          </div>
          <div class="log-content collapsed" id="upload-log"></div>
        </div>
      </div>
    </div>

    <!-- Test 7.4: regenerateSignature -->
    <div class="test-section">
      <div class="test-header">
        <div class="test-title-group">
          <span class="test-number">7.4</span>
          <span class="test-title">regenerateSignature Function</span>
        </div>
        <div class="test-status pending" id="status-7-4">Pending</div>
      </div>
      <div class="test-content">
        <p class="test-description">Exact implementation from <span class="code-ref">the signature frame logicregenerateSignature()</span>. Uses actualBoundingBox metrics for precise text sizing with ZOOM_FACTOR=4.</p>

        <div class="controls">
          <button class="primary" onclick="testRegenerateSignature()">Run regenerateSignature Tests</button>
        </div>

        <div class="font-grid" id="regen-results"></div>

        <div class="data-uri-panel" id="regen-uri-panel" style="display: none;">
          <div class="data-uri-header" onclick="toggleDataUri('regen')">
            <div class="data-uri-title">
              <span class="data-uri-toggle" id="regen-uri-toggle">&#9660;</span>
              <span class="data-uri-label">Data URI</span>
              <span class="data-uri-length" id="regen-uri-length">-</span>
            </div>
            <button class="copy-btn" onclick="event.stopPropagation(); copyDataUri('regen-uri-content', this)">Copy</button>
          </div>
          <div class="data-uri-content" id="regen-uri-content"></div>
        </div>

        <div class="log-panel">
          <div class="log-header" onclick="toggleLog('regen')">
            <span class="log-toggle" id="regen-log-toggle">&#9660;</span>
            <span class="log-title">Debug Log</span>
          </div>
          <div class="log-content collapsed" id="regen-log"></div>
        </div>
      </div>
    </div>

    <!-- Test 7.5: Frame Generation -->
    <div class="test-section">
      <div class="test-header">
        <div class="test-title-group">
          <span class="test-number">7.5</span>
          <span class="test-title">Frame Generation (createFramedSignatureImage)</span>
        </div>
        <div class="test-status pending" id="status-7-5">Pending</div>
      </div>
      <div class="test-content">
        <p class="test-description">Simulates <span class="code-ref">the signature frame logiccreateFramedSignatureImage()</span>. Adds border, logo area, and frameId text to signature images.</p>

        <div class="controls">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="frame-border" checked>
            <span style="font-size: 12px;">Border</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="frame-timestamp">
            <span style="font-size: 12px;">Timestamp</span>
          </label>
          <input type="text" id="frame-id" value="SIG-12345" placeholder="Frame ID" style="width: 120px;">
          <button class="primary" onclick="generateFramedSignatures()">Generate Framed Signatures</button>
        </div>

        <div class="frame-grid" id="frame-results"></div>

        <div class="data-uri-panel" id="frame-uri-panel" style="display: none;">
          <div class="data-uri-header" onclick="toggleDataUri('frame')">
            <div class="data-uri-title">
              <span class="data-uri-toggle" id="frame-uri-toggle">&#9660;</span>
              <span class="data-uri-label">Data URI</span>
              <span class="data-uri-length" id="frame-uri-length">-</span>
            </div>
            <button class="copy-btn" onclick="event.stopPropagation(); copyDataUri('frame-uri-content', this)">Copy</button>
          </div>
          <div class="data-uri-content" id="frame-uri-content"></div>
        </div>

        <div class="log-panel">
          <div class="log-header" onclick="toggleLog('frame')">
            <span class="log-toggle" id="frame-log-toggle">&#9660;</span>
            <span class="log-title">Debug Log</span>
          </div>
          <div class="log-content collapsed" id="frame-log"></div>
        </div>
      </div>
    </div>

    <!-- Test 7.6: Validate Signatures -->
    <div class="test-section">
      <div class="test-header">
        <div class="test-title-group">
          <span class="test-number">7.6</span>
          <span class="test-title">validatePngDataUri Implementation</span>
        </div>
        <div class="test-status pending" id="status-7-6">Pending</div>
      </div>
      <div class="test-content">
        <p class="test-description">Exact implementation from the PNG validation function. Checks PNG format, transparency, and single-color detection with MAX_SINGLE_COLOR_FILL_RATIO=0.9.</p>

        <div class="controls">
          <button class="primary" onclick="validateAllSignatures()">Validate All Captured Signatures</button>
        </div>

        <div class="validation-results" id="validation-results" style="display: none;"></div>

        <div class="log-panel">
          <div class="log-header" onclick="toggleLog('validate')">
            <span class="log-toggle" id="validate-log-toggle">&#9660;</span>
            <span class="log-title">Debug Log</span>
          </div>
          <div class="log-content collapsed" id="validate-log"></div>
        </div>
      </div>
    </div>

    <div class="browser-info" id="browser-info"></div>
  </div>

  <script>
    // =============================================================================
    // Constants (from actual code)
    // =============================================================================
    const DEFAULT_CANVAS_WIDTH = 512;  // from the utils module
    const DEFAULT_CANVAS_HEIGHT = 200; // from the utils module
    const MIN_DPR = 2;                 // from the utils module
    const ZOOM_FACTOR = 4;             // from the signature frame module
    const MIN_FONT_SIZE = 4;           // from the signature frame module
    const REQUIRED_PATH_LENGTH = 42;   // from the draw signature module hasSignature()
    const MAX_SINGLE_COLOR_FILL_RATIO = 0.9; // from the image validator

    // =============================================================================
    // Global State
    // =============================================================================
    const capturedSignatures = [];
    let testsPassed = 0;
    let testsFailed = 0;

    // getDPR() - exact implementation from the utils module
    function getDPR() {
      return Math.max(MIN_DPR, window.devicePixelRatio);
    }
    const dpr = getDPR();

    // =============================================================================
    // Utilities
    // =============================================================================
    function log(prefix, message) {
      const el = document.getElementById(prefix + '-log');
      el.textContent += message + '\n';
      el.scrollTop = el.scrollHeight;
    }

    function setStatus(testId, status, message) {
      const el = document.getElementById(`status-${testId}`);
      el.className = `test-status ${status}`;
      el.textContent = message;

      if (status === 'pass') testsPassed++;
      else if (status === 'fail') testsFailed++;

      updateSummary();
    }

    function updateSummary() {
      document.getElementById('stat-captured').textContent = capturedSignatures.length;
      document.getElementById('stat-passed').textContent = testsPassed;
      document.getElementById('stat-failed').textContent = testsFailed;
    }

    function toggleLog(prefix) {
      const content = document.getElementById(prefix + '-log');
      const toggle = document.getElementById(prefix + '-log-toggle');
      content.classList.toggle('collapsed');
      toggle.classList.toggle('collapsed');
    }

    function toggleDataUri(prefix) {
      const content = document.getElementById(prefix + '-uri-content');
      const toggle = document.getElementById(prefix + '-uri-toggle');
      content.classList.toggle('collapsed');
      toggle.classList.toggle('collapsed');
    }

    function copyDataUri(contentId, btn) {
      const content = document.getElementById(contentId);
      navigator.clipboard.writeText(content.textContent).then(() => {
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'Copy';
          btn.classList.remove('copied');
        }, 2000);
      });
    }

    function showDataUri(panelId, contentId, dataUri) {
      const panel = document.getElementById(panelId);
      const content = document.getElementById(contentId);
      panel.style.display = 'block';
      content.textContent = dataUri;
      const prefix = panelId.replace('-uri-panel', '');
      const lengthEl = document.getElementById(prefix + '-uri-length');
      if (lengthEl) {
        lengthEl.textContent = dataUri.length.toLocaleString() + ' chars';
      }
    }

    // loadImage() - helper function
    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }

    // readFileAsDataURL() - helper function
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // =============================================================================
    // Browser Info
    // =============================================================================
    function renderBrowserInfo() {
      const ua = navigator.userAgent;
      const isFirefox = /Firefox\/(\d+)/.test(ua);
      const firefoxVersion = ua.match(/Firefox\/(\d+)/)?.[1] || '-';

      document.getElementById('stat-dpr').textContent = dpr;

      const items = [
        { label: 'Browser', value: isFirefox ? `Firefox ${firefoxVersion}` : (ua.includes('Chrome') ? 'Chrome' : 'Other') },
        { label: 'Platform', value: navigator.platform },
        { label: 'Device Pixel Ratio', value: window.devicePixelRatio.toFixed(2) + ` (using ${dpr})` },
        { label: 'User Agent', value: ua }
      ];

      document.getElementById('browser-info').innerHTML = `
        <h3>Browser Information</h3>
        <div class="browser-grid">
          ${items.map(item => `
            <div class="browser-item">
              <span class="browser-item-label">${item.label}</span>
              <span class="browser-item-value">${item.value}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    // =============================================================================
    // 7.1 DRAW SIGNATURE MODE (draw signature logic)
    // =============================================================================
    const drawCanvas = document.getElementById('draw-canvas');
    const drawCtx = drawCanvas.getContext('2d');

    // Canvas sizing matching the utils module DEFAULT_CANVAS dimensions
    const displayWidth = DEFAULT_CANVAS_WIDTH;
    const displayHeight = DEFAULT_CANVAS_HEIGHT;
    drawCanvas.width = displayWidth * dpr;
    drawCanvas.height = displayHeight * dpr;
    drawCanvas.style.width = displayWidth + 'px';
    drawCanvas.style.height = displayHeight + 'px';
    drawCtx.scale(dpr, dpr);

    document.getElementById('draw-display-size').textContent = `${displayWidth}x${displayHeight}`;
    document.getElementById('draw-actual-size').textContent = `${drawCanvas.width}x${drawCanvas.height}`;

    // Drawing state
    let isDrawing = false;
    let penColor = '#000000';
    const paths = []; // Array of PointPath-like objects
    let currentPath = null;

    function getPos(e) {
      const rect = drawCanvas.getBoundingClientRect();
      const scaleX = drawCanvas.width / rect.width;
      const scaleY = drawCanvas.height / rect.height;
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      return {
        x: (clientX - rect.left) * scaleX / dpr,
        y: (clientY - rect.top) * scaleY / dpr,
        time: Date.now()
      };
    }

    // hasSignature() - checks if signature has minimum 42px path length
    function hasSignature() {
      let totalLength = 0;
      for (const path of paths) {
        totalLength += path.length;
        if (totalLength > REQUIRED_PATH_LENGTH) return true;
      }
      return false;
    }

    function updatePathInfo() {
      let totalLength = 0;
      paths.forEach(p => totalLength += p.length);
      document.getElementById('draw-path-length').textContent = totalLength.toFixed(1);
      document.getElementById('draw-has-sig').textContent = hasSignature();
    }

    function startDrawing(e) {
      e.preventDefault();
      isDrawing = true;
      const pos = getPos(e);
      currentPath = { points: [pos], length: 0 };
      paths.push(currentPath);
    }

    function draw(e) {
      if (!isDrawing || !currentPath) return;
      e.preventDefault();
      const pos = getPos(e);
      const lastPos = currentPath.points[currentPath.points.length - 1];

      // Calculate segment length
      const dx = pos.x - lastPos.x;
      const dy = pos.y - lastPos.y;
      const segLength = Math.sqrt(dx * dx + dy * dy);
      currentPath.length += segLength;
      currentPath.points.push(pos);

      // Draw the stroke
      drawCtx.strokeStyle = penColor;
      drawCtx.lineCap = 'round';
      drawCtx.lineJoin = 'round';
      drawCtx.lineWidth = 2;

      drawCtx.beginPath();
      drawCtx.moveTo(lastPos.x, lastPos.y);
      drawCtx.lineTo(pos.x, pos.y);
      drawCtx.stroke();

      updatePathInfo();
    }

    function stopDrawing() {
      isDrawing = false;
      currentPath = null;
      updatePathInfo();
    }

    drawCanvas.addEventListener('mousedown', startDrawing);
    drawCanvas.addEventListener('mousemove', draw);
    drawCanvas.addEventListener('mouseup', stopDrawing);
    drawCanvas.addEventListener('mouseout', stopDrawing);
    drawCanvas.addEventListener('touchstart', startDrawing, { passive: false });
    drawCanvas.addEventListener('touchmove', draw, { passive: false });
    drawCanvas.addEventListener('touchend', stopDrawing);

    function selectColor(el) {
      document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
      el.classList.add('selected');
      const newColor = el.dataset.color;

      log('draw', `Color changed: ${penColor} -> ${newColor}`);
      penColor = newColor;

      // forceRedraw() - redraws all paths with new color
      forceRedrawCanvas();
    }

    function forceRedrawCanvas() {
      drawCtx.clearRect(0, 0, displayWidth, displayHeight);
      drawCtx.strokeStyle = penColor;
      drawCtx.lineCap = 'round';
      drawCtx.lineJoin = 'round';
      drawCtx.lineWidth = 2;

      paths.forEach(path => {
        if (path.points.length < 2) return;
        drawCtx.beginPath();
        drawCtx.moveTo(path.points[0].x, path.points[0].y);
        for (let i = 1; i < path.points.length; i++) {
          drawCtx.lineTo(path.points[i].x, path.points[i].y);
        }
        drawCtx.stroke();
      });
    }

    function clearDrawCanvas() {
      drawCtx.clearRect(0, 0, displayWidth, displayHeight);
      paths.length = 0;
      document.getElementById('draw-log').textContent = '';
      document.getElementById('draw-path-length').textContent = '0';
      document.getElementById('draw-has-sig').textContent = 'false';
      document.getElementById('draw-result').src = '';
      document.getElementById('draw-result-size').textContent = '-';
      document.getElementById('draw-pixels').textContent = '-';
      document.getElementById('draw-uri-panel').style.display = 'none';
    }

    // getSignatureFromCanvas() - from the utils module
    function getSignatureFromCanvas(canvas, options) {
      const extractedSignatureData = canvas.toDataURL('image/png');

      return {
        default: 0,
        height: canvas.height,
        data_uri: extractedSignatureData,
        width: canvas.width,
        type: options.fieldType || 'signature',
        width_p: 0,
        height_p: 0,
        from_upload: options.fromMode === 'upload',
        from_text: options.fromMode === 'text',
        ...(options.fromMode === 'text' && {
          text: options.text,
          font_family: options.fontFamily,
          font_color: options.color,
        }),
      };
    }

    function captureDrawSignature() {
      log('draw', `\n--- Capturing signature (getSignatureFromCanvas) ---`);
      log('draw', `Canvas: ${drawCanvas.width}x${drawCanvas.height}`);
      log('draw', `DPR: ${dpr}`);
      log('draw', `hasSignature(): ${hasSignature()}`);

      const sig = getSignatureFromCanvas(drawCanvas, {
        fieldType: 'signature',
        fromMode: 'draw',
      });

      log('draw', `data_uri length: ${sig.data_uri.length}`);
      log('draw', `from_upload: ${sig.from_upload}, from_text: ${sig.from_text}`);

      document.getElementById('draw-result').src = sig.data_uri;
      document.getElementById('draw-result-size').textContent = `${sig.width}x${sig.height}`;

      // Count non-transparent pixels
      const imageData = drawCtx.getImageData(0, 0, drawCanvas.width, drawCanvas.height);
      let nonTransparent = 0;
      for (let i = 0; i < imageData.data.length; i += 4) {
        if (imageData.data[i + 3] > 0) nonTransparent++;
      }

      log('draw', `Non-transparent pixels: ${nonTransparent}`);
      document.getElementById('draw-pixels').textContent = nonTransparent.toLocaleString();

      showDataUri('draw-uri-panel', 'draw-uri-content', sig.data_uri);

      capturedSignatures.push({ type: 'draw', sig, nonTransparent });
      updateSummary();

      if (!hasSignature()) {
        setStatus('7-1', 'fail', 'Below 42px threshold');
      } else if (nonTransparent === 0) {
        setStatus('7-1', 'fail', 'Blank signature!');
      } else {
        setStatus('7-1', 'pass', `${nonTransparent.toLocaleString()} pixels`);
      }
    }

    // =============================================================================
    // 7.2 TEXT SIGNATURE MODE (text signature implementation)
    // =============================================================================

    // getSignatureDataURI() - EXACT implementation from the text signature module
    function getSignatureDataURI(canvas, fontFamily, text, color, deviceDpr) {
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        return '';
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.textAlign = 'center';
      ctx.fillStyle = color;
      ctx.textBaseline = 'middle';
      const textMargin = canvas.width * 0.1;

      // adjust the font size
      let fontSize = 100 * deviceDpr;
      let iterations = 0;
      while (fontSize > 0) {
        iterations++;
        ctx.font = `${fontSize}px ${fontFamily}`;
        const textWidth = ctx.measureText(text).width;
        const targetWidth = canvas.width - textMargin;
        const fraction = textWidth / targetWidth;
        if (fraction <= 1) {
          break;
        }
        // divide if we can
        fontSize = Math.min(fontSize - 1, Math.floor(fontSize / fraction));
      }

      const yPos = canvas.height * 0.5;
      ctx.fillText(text, canvas.width / 2, yPos);

      return { dataUri: canvas.toDataURL('image/png'), fontSize, iterations };
    }

    function generateTextSignatures() {
      const container = document.getElementById('text-results');
      container.innerHTML = '';
      document.getElementById('text-log').textContent = '';

      const text = document.getElementById('sig-text').value || 'Signature';
      const color = document.getElementById('sig-color').value;
      const fonts = ['Dancing Script', 'Great Vibes', 'Arial', 'cursive'];

      log('text', `Generating text signatures for: "${text}"`);
      log('text', `Color: ${color}, DPR: ${dpr}`);
      log('text', `Canvas size: ${DEFAULT_CANVAS_WIDTH * dpr}x${DEFAULT_CANVAS_HEIGHT * dpr}`);

      let issues = [];
      let allDataUris = [];

      fonts.forEach(font => {
        const canvas = document.createElement('canvas');
        canvas.width = DEFAULT_CANVAS_WIDTH * dpr;
        canvas.height = DEFAULT_CANVAS_HEIGHT * dpr;

        const result = getSignatureDataURI(canvas, font, text, color, dpr);

        log('text', `\nFont: ${font}`);
        log('text', `  Final fontSize: ${result.fontSize}px`);
        log('text', `  Iterations: ${result.iterations}`);
        log('text', `  Data URI length: ${result.dataUri.length}`);

        allDataUris.push(`[${font}]\n${result.dataUri}`);

        const sig = getSignatureFromCanvas(canvas, {
          fieldType: 'signature',
          fromMode: 'text',
          text,
          fontFamily: font,
          color,
        });

        const card = document.createElement('div');
        card.className = 'font-card';
        const hasIssue = result.fontSize <= 0;
        card.innerHTML = `
          <div class="font-card-header">
            <span class="font-name">${font}</span>
            <span style="font-size: 11px; color: ${hasIssue ? 'var(--accent-red)' : 'var(--accent-green)'};">${hasIssue ? 'ERROR' : 'OK'}</span>
          </div>
          <div class="font-preview">
            <img src="${result.dataUri}" alt="${font} signature">
          </div>
          <div class="font-meta">
            <span>Size: <strong>${result.fontSize}px</strong></span>
            <span>Iter: <strong>${result.iterations}</strong></span>
            <span>URI: <strong>${result.dataUri.length}</strong></span>
          </div>
        `;
        container.appendChild(card);

        capturedSignatures.push({ type: 'text', font, sig });

        if (hasIssue) {
          issues.push(`${font}: fontSize=0`);
        }
      });

      showDataUri('text-uri-panel', 'text-uri-content', allDataUris.join('\n\n'));
      updateSummary();

      if (issues.length > 0) {
        setStatus('7-2', 'fail', issues.join('; '));
      } else {
        setStatus('7-2', 'pass', 'All fonts OK');
      }
    }

    // =============================================================================
    // 7.3 UPLOAD SIGNATURE MODE (upload signature logic)
    // =============================================================================
    const uploadArea = document.getElementById('upload-area');

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        processUploadedFile(files[0]);
      }
    });

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        processUploadedFile(file);
      }
    }

    async function processUploadedFile(file) {
      log('upload', `\n--- Processing uploaded file ---`);
      log('upload', `File: ${file.name}`);
      log('upload', `Size: ${file.size} bytes`);
      log('upload', `Type: ${file.type}`);

      try {
        const dataUrl = await readFileAsDataURL(file);
        log('upload', `readFileAsDataURL completed`);

        const img = await loadImage(dataUrl);
        log('upload', `loadImage completed: ${img.naturalWidth}x${img.naturalHeight}`);

        document.getElementById('upload-original-size').textContent = `${img.naturalWidth}x${img.naturalHeight}`;

        const uploadCanvas = document.getElementById('upload-canvas');
        uploadCanvas.width = img.naturalWidth;
        uploadCanvas.height = img.naturalHeight;
        uploadCanvas.style.display = 'block';
        document.getElementById('upload-placeholder').style.display = 'none';

        const ctx = uploadCanvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        document.getElementById('upload-display-size').textContent = `${uploadCanvas.width}x${uploadCanvas.height}`;

        // getSignatureFromCanvas
        const sig = getSignatureFromCanvas(uploadCanvas, {
          fieldType: 'signature',
          fromMode: 'upload',
        });

        log('upload', `getSignatureFromCanvas completed`);
        log('upload', `data_uri length: ${sig.data_uri.length}`);

        document.getElementById('upload-result').src = sig.data_uri;
        document.getElementById('upload-result-size').textContent = `${sig.width}x${sig.height}`;

        // Count non-transparent pixels
        const imageData = ctx.getImageData(0, 0, uploadCanvas.width, uploadCanvas.height);
        let nonTransparent = 0;
        for (let i = 0; i < imageData.data.length; i += 4) {
          if (imageData.data[i + 3] > 0) nonTransparent++;
        }

        log('upload', `Non-transparent pixels: ${nonTransparent}`);
        document.getElementById('upload-pixels').textContent = nonTransparent.toLocaleString();

        showDataUri('upload-uri-panel', 'upload-uri-content', sig.data_uri);

        capturedSignatures.push({ type: 'upload', sig, nonTransparent });
        updateSummary();

        if (nonTransparent === 0) {
          setStatus('7-3', 'fail', 'Blank image');
        } else {
          setStatus('7-3', 'pass', `${nonTransparent.toLocaleString()} pixels`);
        }
      } catch (e) {
        log('upload', `ERROR: ${e.message}`);
        setStatus('7-3', 'fail', e.message);
      }
    }

    // =============================================================================
    // 7.4 REGENERATE SIGNATURE (signature frame implementation)
    // =============================================================================

    // regenerateSignature() - EXACT implementation from the signature frame module
    function regenerateSignature(sign) {
      const canRegenerate = Boolean(sign.text && sign.font_family && sign.font_color);
      if (!canRegenerate) return sign.data_uri;

      const canvas = document.createElement('canvas');
      canvas.height = sign.infoLines?.length
        ? sign.height * 2  // CFR11_ZOOM_FACTOR = 2
        : sign.height * ZOOM_FACTOR;
      canvas.width = canvas.height;
      let fontSize = canvas.height;

      const ctx = canvas.getContext('2d');
      const setContext = (size) => {
        ctx.font = `${size}px ${sign.font_family}`;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        ctx.fillStyle = `#${sign.font_color}`;
      };

      setContext(fontSize);
      let metrics = ctx.measureText(sign.text);

      if (metrics.width > sign.width * ZOOM_FACTOR) {
        const factor = (sign.width * ZOOM_FACTOR) / metrics.width;
        fontSize = Math.max(fontSize * factor, MIN_FONT_SIZE);
        setContext(fontSize);
        metrics = ctx.measureText(sign.text);
      }

      canvas.width = metrics.actualBoundingBoxRight + metrics.actualBoundingBoxLeft;
      canvas.height = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;
      setContext(fontSize);
      ctx.fillText(sign.text, metrics.actualBoundingBoxLeft, metrics.actualBoundingBoxAscent);

      return canvas.toDataURL('image/png');
    }

    function testRegenerateSignature() {
      const container = document.getElementById('regen-results');
      container.innerHTML = '';
      document.getElementById('regen-log').textContent = '';

      const testCases = [
        { text: 'John Smith', font_family: 'Dancing Script', font_color: '000000', height: 100, width: 300 },
        { text: 'J', font_family: 'Arial', font_color: '0000ff', height: 50, width: 50 },
        { text: 'A very long signature name that exceeds width', font_family: 'Arial', font_color: 'ff0000', height: 30, width: 100 },
        { text: '   ', font_family: 'Arial', font_color: '000000', height: 50, width: 200 },
        { text: 'Test', font_family: 'NonExistentFont123', font_color: '006400', height: 50, width: 200 },
      ];

      log('regen', `Testing regenerateSignature() - exact implementation from the signature frame module`);
      log('regen', `ZOOM_FACTOR=${ZOOM_FACTOR}, MIN_FONT_SIZE=${MIN_FONT_SIZE}`);

      let issues = [];
      let allDataUris = [];

      testCases.forEach((tc, i) => {
        log('regen', `\nTest ${i + 1}: "${tc.text.substring(0, 20)}${tc.text.length > 20 ? '...' : ''}"`);
        log('regen', `  Font: ${tc.font_family}, Color: #${tc.font_color}`);
        log('regen', `  Target size: ${tc.width}x${tc.height}`);

        const dataUri = regenerateSignature(tc);

        // Get result dimensions
        const img = new Image();
        img.src = dataUri;

        log('regen', `  Data URI length: ${dataUri.length}`);
        allDataUris.push(`[Test ${i + 1}: "${tc.text.substring(0, 15)}"]\n${dataUri}`);

        const card = document.createElement('div');
        card.className = 'font-card';
        const displayText = tc.text.length > 15 ? tc.text.substring(0, 15) + '...' : tc.text;
        const isBlank = dataUri.length < 100;

        card.innerHTML = `
          <div class="font-card-header">
            <span class="font-name">"${displayText}"</span>
            <span style="font-size: 11px; color: ${isBlank ? 'var(--accent-red)' : 'var(--accent-green)'};">${isBlank ? 'BLANK' : 'OK'}</span>
          </div>
          <div class="font-preview">
            <img src="${dataUri}" alt="Regenerated signature">
          </div>
          <div class="font-meta">
            <span>Font: <strong>${tc.font_family}</strong></span>
            <span>URI: <strong>${dataUri.length}</strong></span>
          </div>
        `;
        container.appendChild(card);

        capturedSignatures.push({ type: 'regen', text: tc.text, dataUri });

        if (isBlank) {
          issues.push(`"${tc.text.substring(0, 10)}": blank`);
        }
      });

      showDataUri('regen-uri-panel', 'regen-uri-content', allDataUris.join('\n\n'));
      updateSummary();

      if (issues.length > 0) {
        setStatus('7-4', 'warn', `${issues.length} warnings`);
      } else {
        setStatus('7-4', 'pass', 'All valid');
      }
    }

    // =============================================================================
    // 7.5 FRAME GENERATION (createFramedSignatureImage logic)
    // =============================================================================

    // Simplified frame generation mimicking createFramedSignatureImage
    async function createFramedSignatureImage(dataUri, options) {
      const { frameId, borderEnabled, width, height } = options;

      const img = await loadImage(dataUri);

      const MARGIN = 6;
      const FONT_SIZE = 8;
      const BORDER_RADIUS = 7;
      const LOGO_LINE_HEIGHT = 1.2;

      // Calculate framed canvas size
      const frameHeight = height;
      const frameWidth = width;

      const canvas = document.createElement('canvas');
      canvas.width = frameWidth;
      canvas.height = frameHeight;
      const ctx = canvas.getContext('2d');

      // White background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, frameWidth, frameHeight);

      // Calculate signature area
      const sigAreaTop = MARGIN;
      const sigAreaBottom = frameHeight - MARGIN - (borderEnabled ? FONT_SIZE * LOGO_LINE_HEIGHT + MARGIN : 0);
      const sigAreaHeight = sigAreaBottom - sigAreaTop;
      const sigAreaWidth = frameWidth - 2 * MARGIN;

      // Scale and center signature
      const scale = Math.min(sigAreaWidth / img.naturalWidth, sigAreaHeight / img.naturalHeight);
      const sigW = img.naturalWidth * scale;
      const sigH = img.naturalHeight * scale;
      const sigX = MARGIN + (sigAreaWidth - sigW) / 2;
      const sigY = sigAreaTop + (sigAreaHeight - sigH) / 2;

      ctx.drawImage(img, sigX, sigY, sigW, sigH);

      if (borderEnabled) {
        // Draw frameId at bottom right
        ctx.font = `400 ${FONT_SIZE}px Lato`;
        ctx.textAlign = 'right';
        ctx.textBaseline = 'bottom';
        ctx.fillStyle = '#222222';
        ctx.fillText(frameId, frameWidth - MARGIN, frameHeight - MARGIN);

        // Draw "SignApp" text at bottom left (placeholder for logo)
        ctx.textAlign = 'left';
        ctx.fillText('SignApp', MARGIN, frameHeight - MARGIN);

        // Draw border
        ctx.strokeStyle = '#d3d3d3';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.roundRect(1, 1, frameWidth - 2, frameHeight - 2, BORDER_RADIUS);
        ctx.stroke();
      }

      return {
        dataUri: canvas.toDataURL('image/png'),
        width: frameWidth,
        height: frameHeight,
      };
    }

    async function generateFramedSignatures() {
      const container = document.getElementById('frame-results');
      container.innerHTML = '';
      document.getElementById('frame-log').textContent = '';

      const borderEnabled = document.getElementById('frame-border').checked;
      const timestampEnabled = document.getElementById('frame-timestamp').checked;
      const frameId = document.getElementById('frame-id').value || 'SIG-00000';

      log('frame', `Generating framed signatures`);
      log('frame', `borderEnabled: ${borderEnabled}, timestampEnabled: ${timestampEnabled}`);
      log('frame', `frameId: ${frameId}`);

      // Get captured signatures to frame
      const sigsToFrame = capturedSignatures.filter(s => s.sig?.data_uri || s.dataUri);

      if (sigsToFrame.length === 0) {
        log('frame', `No signatures captured yet. Generate some signatures first.`);
        setStatus('7-5', 'warn', 'No signatures');
        return;
      }

      let allDataUris = [];
      let issues = [];

      for (const sig of sigsToFrame.slice(0, 4)) { // Limit to 4 for display
        const sourceUri = sig.sig?.data_uri || sig.dataUri;
        const label = sig.type === 'text' ? `Text (${sig.font})` :
                      sig.type === 'draw' ? 'Draw' :
                      sig.type === 'upload' ? 'Upload' : 'Regen';

        log('frame', `\nFraming: ${label}`);

        try {
          const framed = await createFramedSignatureImage(sourceUri, {
            frameId,
            borderEnabled,
            timestampEnabled,
            width: 300,
            height: 120,
          });

          log('frame', `  Result: ${framed.width}x${framed.height}`);
          log('frame', `  Data URI length: ${framed.dataUri.length}`);

          allDataUris.push(`[${label}]\n${framed.dataUri}`);

          const card = document.createElement('div');
          card.className = 'frame-card';
          card.innerHTML = `
            <div class="frame-card-header">
              <span class="frame-card-title">${label}</span>
              <span style="font-size: 11px; color: var(--accent-green);">OK</span>
            </div>
            <div class="frame-preview">
              <img src="${framed.dataUri}" alt="Framed signature">
            </div>
            <div class="frame-meta">
              <span>Size: <strong>${framed.width}x${framed.height}</strong></span>
              <span>Frame ID: <strong>${frameId}</strong></span>
              <span>Border: <strong>${borderEnabled}</strong></span>
            </div>
          `;
          container.appendChild(card);

          capturedSignatures.push({ type: 'framed', source: label, dataUri: framed.dataUri });
        } catch (e) {
          log('frame', `  ERROR: ${e.message}`);
          issues.push(label);
        }
      }

      showDataUri('frame-uri-panel', 'frame-uri-content', allDataUris.join('\n\n'));
      updateSummary();

      if (issues.length > 0) {
        setStatus('7-5', 'fail', `${issues.length} failed`);
      } else {
        setStatus('7-5', 'pass', `${sigsToFrame.length} framed`);
      }
    }

    // =============================================================================
    // 7.6 VALIDATE PNG DATA URI (image validator implementation)
    // =============================================================================

    // validatePngDataUri() - Simplified implementation based on the image validator
    async function validatePngDataUri(dataUri) {
      // Step 1: Check format
      if (!dataUri.startsWith('data:image/png;base64,')) {
        return { isValid: false, reason: 'Invalid PNG data URI format' };
      }

      // Step 2: Load and analyze
      try {
        const img = await loadImage(dataUri);

        if (img.width === 0 || img.height === 0) {
          return { isValid: false, reason: 'Image has zero dimensions' };
        }

        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const totalPixels = canvas.width * canvas.height;

        let hasVisible = false;
        let firstColor = null;
        let foundDifferent = false;
        let totalVisible = 0;

        for (let i = 0; i < data.length; i += 4) {
          const alpha = data[i + 3];

          if (alpha > 0) {
            totalVisible++;
            const color = (data[i] << 16) | (data[i + 1] << 8) | data[i + 2];

            if (!hasVisible) {
              hasVisible = true;
              firstColor = color;
            } else if (!foundDifferent && color !== firstColor) {
              foundDifferent = true;
            }
          }
        }

        // Check 1: Must have visible pixels
        if (!hasVisible) {
          return { isValid: false, reason: 'Image is fully transparent' };
        }

        // Check 2: Single color filling most of canvas
        if (!foundDifferent) {
          const fillRatio = totalVisible / totalPixels;
          if (fillRatio > MAX_SINGLE_COLOR_FILL_RATIO) {
            return { isValid: false, reason: 'Image is a single solid color' };
          }
        }

        return {
          isValid: true,
          width: canvas.width,
          height: canvas.height,
          totalVisible,
          fillRatio: (totalVisible / totalPixels * 100).toFixed(1) + '%'
        };
      } catch (e) {
        return { isValid: false, reason: `Failed to process: ${e.message}` };
      }
    }

    async function validateAllSignatures() {
      document.getElementById('validate-log').textContent = '';
      const resultsContainer = document.getElementById('validation-results');
      resultsContainer.innerHTML = '';

      if (capturedSignatures.length === 0) {
        log('validate', 'No signatures captured yet. Generate some signatures first.');
        setStatus('7-6', 'warn', 'No signatures');
        resultsContainer.style.display = 'none';
        return;
      }

      log('validate', `Validating ${capturedSignatures.length} signatures`);
      log('validate', `Using validatePngDataUri() from the image validator`);
      log('validate', `MAX_SINGLE_COLOR_FILL_RATIO: ${MAX_SINGLE_COLOR_FILL_RATIO}`);

      resultsContainer.style.display = 'block';
      let passed = 0, failed = 0;

      for (const sig of capturedSignatures) {
        const dataUri = sig.sig?.data_uri || sig.dataUri;
        if (!dataUri) continue;

        const label = sig.font ? `Text (${sig.font})` :
                      sig.text ? `Regen ("${sig.text.substring(0, 10)}")` :
                      sig.source ? `Framed (${sig.source})` :
                      sig.type === 'draw' ? 'Draw' :
                      sig.type === 'upload' ? 'Upload' : sig.type;

        log('validate', `\n${label}:`);

        const result = await validatePngDataUri(dataUri);

        const item = document.createElement('div');
        item.className = 'validation-item';

        if (result.isValid) {
          log('validate', `  VALID: ${result.width}x${result.height}, ${result.totalVisible} visible px (${result.fillRatio})`);
          passed++;
          item.innerHTML = `
            <span class="validation-name">${label}</span>
            <span class="validation-status valid">${result.width}x${result.height} | ${result.totalVisible} px</span>
          `;
        } else {
          log('validate', `  INVALID: ${result.reason}`);
          failed++;
          item.innerHTML = `
            <span class="validation-name">${label}</span>
            <span class="validation-status invalid">${result.reason}</span>
          `;
        }

        resultsContainer.appendChild(item);
      }

      log('validate', `\n--- Summary ---`);
      log('validate', `Passed: ${passed}, Failed: ${failed}`);

      if (failed > 0) {
        setStatus('7-6', 'fail', `${failed} invalid`);
      } else {
        setStatus('7-6', 'pass', `All ${passed} valid`);
      }
    }

    // =============================================================================
    // Initialize
    // =============================================================================
    renderBrowserInfo();

    document.fonts.ready.then(() => {
      log('draw', 'Fonts loaded. Ready to draw.');
      log('text', 'Fonts loaded. Ready to generate text signatures.');
    });
  </script>
</body>
</html>
